<!DOCTYPE html>
<html>
<head>
    <title>Personal Score Tracker (Offline)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body { background-color: #f8f9f8; font-family: 'Arial', sans-serif; }
        .container { max-width: 900px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 40px; }
        .locked-row { background-color: #e9e9e9; }
    </style>
</head>
<body>

<div class='container'>
    <h2 class='text-center text-success mb-4'><i class="fas fa-user"></i> Personal Score Tracker (Offline)</h2>

    <form id="offline-score-form">
        <div class='mb-3'>
            <label>Select Course:</label>
            <select id='course_id' class='form-control' required></select>
        </div>
        <div class='mb-3'>
            <label>Gender:</label>
            <select id='gender' class='form-control' required>
                <option value='Men'>Men</option>
                <option value='Women'>Women</option>
            </select>
        </div>
        <div class='mb-3'>
            <label>Select Tee:</label>
            <select id='tee_color' class='form-control' required>
                <option value='White'>White</option>
                <option value='Yellow'>Yellow</option>
                <option value='Blue'>Blue</option>
                <option value='Red'>Red</option>
                <option value='Orange'>Orange</option>
                <option value='Black'>Black</option>
                <option value='Gold'>Gold</option>
            </select>
        </div>
        <div class='mb-3'>
            <label>Your Handicap:</label>
            <input type='number' step='0.1' id='handicap' class='form-control' required>
        </div>
        <div class='mb-3'>
            <label>Date Played:</label>
            <input type='date' id='date_played' class='form-control' required>
        </div>
        <button type='button' class='btn btn-masters-green btn-transition w-100 py-2' onclick='generateTable()'>Calculate</button>
    </form>

    <hr>

    <div id="score-section" style="display:none;">
        <div class='mb-3'>
            <label>Playing Handicap:</label>
            <input type='text' class='form-control' id='playing_handicap' readonly>
        </div>
        <div class="table-responsive">
            <table class='table table-hover text-center' id="score-table">
                <thead>
                    <tr><th>Hole</th><th>Par</th><th>Strokes Given</th><th>Strokes Taken</th><th>Stableford Points</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class='btn btn-masters-green-invert btn-transition w-100 py-2' onclick="saveOffline()">Save to Device</button>
        <button class='btn btn-secondary mt-2 w-100' onclick="viewSaved()">View Saved</button>
        <pre id="saved-output" class="mt-2" style="display:none;"></pre>
    </div>
</div>

<script>
  window.addEventListener('DOMContentLoaded', () => {
  const storedCourses = localStorage.getItem('golf_courses');
  const courseSelect = document.getElementById('course_id');

  if (storedCourses) {
    const courses = JSON.parse(storedCourses);
    courses.forEach(course => {
      const option = document.createElement('option');
      option.value = course.id;
      option.textContent = course.name;
      courseSelect.appendChild(option);
    });
  } else {
    const option = document.createElement('option');
    option.textContent = "⚠️ No courses available (load once online)";
    option.disabled = true;
    courseSelect.appendChild(option);
  }
});
</script>
<script>
let touchStartX = null;
const STORAGE_KEY = 'offline_personal_score';

function generateTable() {
    const handicap = parseFloat(document.getElementById('handicap').value) || 0;
    document.getElementById('playing_handicap').value = handicap.toFixed(1);
    document.querySelector('#score-table tbody').innerHTML = '';

    for (let i = 1; i <= 18; i++) {
        const row = document.createElement('tr');
        row.id = `row_${i}`;
        row.innerHTML = `
            <td><strong>${i}</strong></td>
            <td>4</td>
            <td>1</td>
            <td><input type="number" inputmode="numeric" pattern="[0-9]*" id="strokes_hole_${i}" class="form-control text-center" oninput="updateStableford(${i})"></td>
            <td id="stableford_hole_${i}">-</td>
        `;
        document.querySelector('#score-table tbody').appendChild(row);
    }

    document.getElementById('score-section').style.display = 'block';
}

function updateStableford(holeId) {
    const input = document.getElementById('strokes_hole_' + holeId);
    const par = 4;
    const strokesGiven = 1;
    const strokesTaken = parseInt(input.value) || 0;
    const netScore = strokesTaken - strokesGiven;
    const stableford = calculateStableford(par, netScore);
    document.getElementById('stableford_hole_' + holeId).innerText = stableford;
}

function calculateStableford(par, netScore) {
    const scoreDiff = netScore - par;
    if (scoreDiff <= -4) return 6;
    if (scoreDiff === -3) return 5;
    if (scoreDiff === -2) return 4;
    if (scoreDiff === -1) return 3;
    if (scoreDiff === 0) return 2;
    if (scoreDiff === 1) return 1;
    return 0;
}

function saveOffline() {
    const data = {
        course: document.getElementById('course_id').value,
        gender: document.getElementById('gender').value,
        tee: document.getElementById('tee_color').value,
        handicap: document.getElementById('handicap').value,
        date: document.getElementById('date_played').value,
        strokes: {}
    };
    for (let i = 1; i <= 18; i++) {
        data.strokes['hole_' + i] = document.getElementById('strokes_hole_' + i).value;
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    alert('Offline round saved!');
}

function viewSaved() {
    const output = document.getElementById('saved-output');
    const data = localStorage.getItem(STORAGE_KEY);
    output.style.display = 'block';
    output.innerText = data || 'No saved data.';
}
</script>
<nav class="mobile-nav two-items"> 
  <ul>
      <li><a href="{{ url_for('courses') }}" class="nav-link">Courses</a></li>
      <li><a href="{{ url_for('user_rounds') }}" class="nav-link">Back</a></li>
  </ul>
</nav>  
</body>
</html>
